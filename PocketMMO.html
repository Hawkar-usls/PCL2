<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lineage 2: Pocket</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tahoma&display=swap" rel="stylesheet">

    <style>
        /* L2 UI THEME */
        :root {
            --l2-bg: rgba(16, 20, 24, 0.96);
            --l2-border: #4a5058;
            --l2-border-dark: #1c1f24;
            --l2-text: #b8c0cc;
            --l2-gold: #d4b568;
        }

        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; font-family: 'Tahoma', sans-serif; user-select: none; -webkit-user-select: none; }
        #game-container { width: 100%; height: 100vh; image-rendering: pixelated; }

        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .pointer-auto { pointer-events: auto; }

        /* WINDOW STYLE */
        .l2-window {
            background: var(--l2-bg);
            border: 1px solid #353b42;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1), 0 4px 15px rgba(0,0,0,0.9);
            border-radius: 2px;
            color: var(--l2-text);
            font-size: 11px;
            position: absolute;
        }
        .window-title {
            background: linear-gradient(to bottom, #2c323a, #1a1e24);
            padding: 4px 8px; font-weight: bold; color: #e0e0e0; border-bottom: 1px solid #353b42;
            display: flex; justify-content: space-between; align-items: center; cursor: move;
        }

        /* INVENTORY (Redesigned) */
        .inv-window {
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 500px; height: 380px; display: none; flex-direction: column;
        }
        .inv-body { display: flex; flex: 1; overflow: hidden; }
        
        /* PAPERDOLL (Left Side) */
        .paperdoll-panel {
            width: 180px; background: #121416; border-right: 1px solid #353b42;
            position: relative; padding: 10px;
        }
        .doll-grid {
            display: grid; 
            grid-template-areas: 
                ". head ."
                "wep chest shield"
                "gloves legs boots";
            gap: 8px; justify-content: center; margin-top: 20px;
        }
        .doll-slot {
            width: 36px; height: 36px; background: #1c1f24; border: 1px solid #444;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; color: #333; cursor: pointer; position: relative;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }
        .doll-slot.filled { border-color: #888; color: #fff; background: #2c323a; }
        .doll-slot i { pointer-events: none; }
        
        /* ITEMS GRID (Right Side) */
        .items-panel { flex: 1; display: flex; flex-direction: column; background: #181b20; }
        .inv-tabs { display: flex; gap: 1px; background: #101214; border-bottom: 1px solid #353b42; }
        .inv-tab { padding: 6px 12px; background: #2c323a; border-right: 1px solid #353b42; cursor: pointer; color: #888; }
        .inv-tab.active { background: #3a4049; color: #fff; }
        
        .inv-grid {
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 3px; padding: 8px;
            overflow-y: auto; align-content: start; flex: 1;
        }
        .inv-slot {
            aspect-ratio: 1; background: #1c1f24; border: 1px solid #353b42;
            display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative;
        }
        .inv-slot:hover { border-color: #d4b568; }
        .inv-slot .qty { position: absolute; bottom: 1px; right: 2px; font-size: 9px; color: #fff; text-shadow: 1px 1px 0 #000; }
        .inv-slot.equipped { border-color: #4ade80; box-shadow: inset 0 0 5px #4ade80; }

        /* STATUS HUD */
        .status-hud { position: absolute; top: 16px; left: 16px; width: 220px; background: rgba(0, 0, 0, 0.6); border: 1px solid #444; padding: 2px; }
        .hud-name { color: #d4b568; font-weight: bold; font-size: 12px; margin-left: 4px; text-shadow: 1px 1px 0 #000; }
        .bar-container { height: 12px; background: #111; border: 1px solid #333; margin: 1px 0; position: relative; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.2s; }
        .cp-fill { background: linear-gradient(to bottom, #b36f19, #854d05); }
        .hp-fill { background: linear-gradient(to bottom, #9e1e1e, #5e0a0a); }
        .mp-fill { background: linear-gradient(to bottom, #1e579e, #0a2a5e); }
        .bar-overlay { position: absolute; inset: 0; display: flex; justify-content: space-between; padding: 0 4px; align-items: center; font-size: 9px; color: #fff; text-shadow: 1px 1px 0 #000; z-index: 2; }

        /* TARGET HUD */
        .target-hud {
            position: absolute; top: 16px; left: 50%; transform: translateX(-50%);
            width: 200px; background: rgba(0,0,0,0.6); border: 1px solid #666; padding: 2px;
            display: none;
        }
        .target-name { color: #ff7777; font-weight: bold; font-size: 12px; text-align: center; text-shadow: 1px 1px 0 #000; }

        /* BUFF BAR */
        .buff-bar { position: absolute; top: 85px; left: 16px; display: flex; flex-wrap: wrap; gap: 2px; max-width: 240px; }
        .buff-icon { width: 20px; height: 20px; background: #000; border: 1px solid #666; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #fff; box-shadow: 1px 1px 2px #000; }

        /* SHORTCUT BAR */
        .shortcut-container {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); border: 1px solid #444; border-radius: 4px;
            padding: 2px; display: flex; gap: 2px;
            overflow-x: auto; max-width: 95vw;
            scrollbar-width: none;
        }
        .shortcut-container::-webkit-scrollbar { display: none; }
        
        .shot-slot {
            width: 42px; height: 42px; background: #1c1f24; border: 1px solid #444;
            display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative;
            flex-shrink: 0;
        }
        .shot-slot:active { transform: translateY(1px); border-color: #888; }
        .shot-slot.active { border-color: #d4b568; box-shadow: inset 0 0 10px rgba(212, 181, 104, 0.5); }
        .shot-slot .key { position: absolute; top: 1px; right: 2px; font-size: 8px; color: #aaa; font-family: monospace; }
        .shot-slot .cooldown { 
            position: absolute; inset: 0; background: rgba(0,0,0,0.7); 
            transform-origin: bottom; transition: height 0.1s linear; height: 0%; pointer-events: none; 
        }
        .shot-slot i { font-size: 18px; filter: drop-shadow(1px 1px 0 #000); }

        /* SYSTEM & INVENTORY */
        .l2-window { background: var(--l2-bg); border: 1px solid #353b42; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1), 0 4px 15px rgba(0,0,0,0.9); border-radius: 2px; color: var(--l2-text); font-size: 11px; position: absolute; }
        .window-title { background: linear-gradient(to bottom, #2c323a, #1a1e24); padding: 4px 8px; font-weight: bold; color: #e0e0e0; border-bottom: 1px solid #353b42; display: flex; justify-content: space-between; align-items: center; cursor: move; }
        .inv-window { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 500px; height: 380px; display: none; flex-direction: column; z-index: 200; }
        .inv-body { display: flex; flex: 1; overflow: hidden; }
        .paperdoll-panel { width: 180px; background: #121416; border-right: 1px solid #353b42; padding: 10px; }
        .items-panel { flex: 1; display: flex; flex-direction: column; background: #181b20; }
        .sys-menu { top: 100px; right: 16px; width: 150px; display: none; flex-direction: column; gap: 1px; }
        .sys-btn { display: flex; align-items: center; gap: 8px; padding: 6px 10px; background: linear-gradient(to bottom, #3a4049, #252a30); border: 1px solid #1c1f24; color: #b8c0cc; cursor: pointer; }
        
        .doll-grid { display: grid; grid-template-areas: ". head ." "wep chest shield" "gloves legs boots"; gap: 8px; justify-content: center; margin-top: 20px; }
        .doll-slot { width: 36px; height: 36px; background: #1c1f24; border: 1px solid #444; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #333; cursor: pointer; }
        .doll-slot.filled { border-color: #888; color: #fff; background: #2c323a; }
        
        .inv-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 3px; padding: 8px; overflow-y: auto; align-content: start; flex: 1; }
        .inv-slot { aspect-ratio: 1; background: #1c1f24; border: 1px solid #353b42; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; }
        .inv-slot:hover { border-color: #d4b568; }
        .inv-slot.equipped { border-color: #4ade80; box-shadow: inset 0 0 5px #4ade80; }

        /* PARTY */
        .party-list { position: absolute; top: 110px; left: 16px; display: flex; flex-direction: column; gap: 2px; }
        .party-member { width: 140px; background: rgba(0,0,0,0.6); border: 1px solid #444; padding: 2px 4px; color: #ccc; font-size: 10px; }
        .pm-bar { height: 3px; background: #111; margin-top: 2px; }
        .pm-hp { height: 100%; background: #9e1e1e; width: 100%; }

        /* CHAT */
        .chat-box { position: absolute; bottom: 60px; left: 16px; width: 300px; height: 150px; background: rgba(0,0,0,0.5); border: 1px solid #444; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; padding: 4px; font-size: 11px; text-shadow: 1px 1px 0 #000; overflow: hidden; mask-image: linear-gradient(to top, black 80%, transparent 100%); }
        .sys { color: #b0b0b0; } .gain { color: #00aaff; } .drop { color: #d4b568; }
    </style>
</head>
<body>

<div id="game-container"></div>

<div class="ui-layer">
    <!-- STATUS -->
    <div class="status-hud pointer-auto">
        <div class="hud-name"><span id="ui-name">Player</span> <span class="text-gray-400">Lv.24</span></div>
        <div class="bar-container"><div class="bar-fill cp-fill" style="width:100%"></div><div class="bar-overlay"><span>CP</span><span>800</span></div></div>
        <div class="bar-container"><div class="bar-fill hp-fill" id="hp-bar" style="width:100%"></div><div class="bar-overlay"><span>HP</span><span id="hp-txt">1200</span></div></div>
        <div class="bar-container"><div class="bar-fill mp-fill" id="mp-bar" style="width:100%"></div><div class="bar-overlay"><span>MP</span><span>450</span></div></div>
    </div>

    <!-- TARGET HUD -->
    <div class="target-hud pointer-auto" id="target-hud">
        <div class="target-name" id="target-name">Target</div>
        <div class="bar-container"><div class="bar-fill hp-fill" id="target-hp-bar" style="width:100%"></div></div>
    </div>

    <!-- BUFF BAR -->
    <div class="buff-bar" id="buff-container"></div>

    <!-- PARTY -->
    <div class="party-list" id="party-list"></div>

    <!-- SYSTEM MENU -->
    <div class="sys-menu l2-window pointer-auto" id="sys-menu">
        <div class="window-title" id="sys-drag">System <i class="fas fa-times cursor-pointer" onclick="game.ui.toggleSys()"></i></div>
        <div class="sys-btn" onclick="game.ui.toggleInv()"><i class="fas fa-box-open text-yellow-500"></i> Inventory</div>
        <div class="sys-btn"><i class="fas fa-user text-blue-400"></i> Status</div>
        <div class="sys-btn"><i class="fas fa-cog text-gray-400"></i> Options</div>
    </div>

    <!-- INVENTORY WINDOW (PAPERDOLL) -->
    <div class="inv-window l2-window pointer-auto" id="inv-window">
        <div class="window-title" id="inv-drag">
            <span>Inventory</span>
            <i class="fas fa-times cursor-pointer hover:text-white" onclick="game.ui.toggleInv()"></i>
        </div>
        <div class="inv-body">
            <!-- LEFT: PAPERDOLL -->
            <div class="paperdoll-panel">
                <div class="text-center text-[#d4b568] mb-2 text-[10px]">EQUIPMENT</div>
                <div class="doll-grid">
                    <div class="doll-slot" style="grid-area: head" id="slot-helm" onclick="game.logic.unequip('helm')"><i class="fas fa-hard-hat opacity-20"></i></div>
                    <div class="doll-slot" style="grid-area: wep" id="slot-weapon" onclick="game.logic.unequip('weapon')"><i class="fas fa-khanda opacity-20"></i></div>
                    <div class="doll-slot" style="grid-area: chest" id="slot-armor" onclick="game.logic.unequip('armor')"><i class="fas fa-tshirt opacity-20"></i></div>
                    <div class="doll-slot" style="grid-area: shield"><i class="fas fa-shield-alt opacity-20"></i></div>
                    <div class="doll-slot" style="grid-area: gloves" id="slot-gloves" onclick="game.logic.unequip('gloves')"><i class="fas fa-mitten opacity-20"></i></div>
                    <div class="doll-slot" style="grid-area: legs"><i class="fas fa-socks opacity-20"></i></div>
                    <div class="doll-slot" style="grid-area: boots" id="slot-boots" onclick="game.logic.unequip('boots')"><i class="fas fa-boot opacity-20"></i></div>
                </div>
                <div class="mt-4 text-[10px] text-gray-400 text-center">
                    P.Atk: <span id="ui-patk" class="text-white">0</span><br>
                    P.Def: <span id="ui-pdef" class="text-white">0</span>
                </div>
            </div>
            
            <!-- RIGHT: ITEMS -->
            <div class="items-panel">
                <div class="inv-tabs">
                    <div class="inv-tab active">All</div>
                    <div class="inv-tab">Equip</div>
                    <div class="inv-tab">Etc</div>
                </div>
                <div class="inv-grid" id="inv-grid"></div>
                <div class="p-2 border-t border-[#353b42] flex justify-between bg-[#101214]">
                    <span class="text-gray-500">Adena:</span> 
                    <span class="text-[#d4b568]" id="ui-adena">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- CHAT -->
    <div class="chat-box" id="chat"></div>

    <!-- SHORTCUT BAR -->
    <div class="shortcut-container pointer-auto" id="shortcut-bar"></div>
</div>

<script>
const ITEMS = {
    'weapon_d': { name: 'Bastard Sword', icon: 'ðŸ—¡ï¸', type: 'gear', slot: 'weapon', pAtk: 45, color: 0xcccccc },
    'armor_d': { name: 'Bronze Armor', icon: 'ðŸ‘•', type: 'gear', slot: 'armor', pDef: 40, color: 0xcd7f32 },
    'helm_d': { name: 'Bronze Helm', icon: 'ðŸª–', type: 'gear', slot: 'helm', pDef: 15, color: 0xcd7f32 },
    'gloves_d': { name: 'Leather Gloves', icon: 'ðŸ§¤', type: 'gear', slot: 'gloves', pDef: 10, color: 0x8b4513 },
    'boots_d': { name: 'Leather Boots', icon: 'ðŸ‘¢', type: 'gear', slot: 'boots', pDef: 10, color: 0x8b4513 },
    'potion': { name: 'Healing Potion', icon: 'ðŸ§ª', type: 'use', stack: true, heal: 50, cd: 5000 },
    'ssd': { name: 'Soulshot', icon: 'âš¡', type: 'etc', stack: true }
};

const BUFFS = {
    'Might': { color: '#c23a3a', icon: 'fa-fist-raised', stat: 'pAtk', val: 1.15, dur: 1200000 },
    'Shield': { color: '#5555ff', icon: 'fa-shield-alt', stat: 'pDef', val: 1.15, dur: 1200000 },
    'Haste': { color: '#ffff00', icon: 'fa-running', stat: 'atkSpd', val: 0.8, dur: 1200000 },
    'Dance of Fire': { color: '#ff5500', icon: 'fa-fire', stat: 'critDmg', val: 1.3, dur: 300000 },
    'Song of Hunter': { color: '#00ff00', icon: 'fa-crosshairs', stat: 'critRate', val: 2.0, dur: 300000 }
};

const SKILLS = {
    'PowerStrike': { name: 'Power Strike', icon: 'fa-gavel', color: '#ff4444', cd: 3000, dmgMod: 1.5, cost: 10 },
    'Stun':        { name: 'Stun', icon: 'fa-bolt', color: '#ffff00', cd: 8000, dmgMod: 1.0, cost: 20 },
    'HydroBlast':  { name: 'Hydro Blast', icon: 'fa-water', color: '#00aaff', cd: 2000, dmgMod: 1.8, cost: 15, range: 200 },
    'Heal':        { name: 'Heal', icon: 'fa-heart', color: '#ff00ff', cd: 4000, type: 'heal', val: 80, cost: 20 },
    'DeadlyBlow':  { name: 'Deadly Blow', icon: 'fa-skull', color: '#550000', cd: 5000, dmgMod: 2.5, cost: 15 },
    'Dash':        { name: 'Dash', icon: 'fa-running', color: '#00ff00', cd: 15000, type: 'buff', speed: 1.5, dur: 10000, cost: 10 }
};

class GameScene extends Phaser.Scene {
    constructor() { super('Game'); }

    preload() {
        const g = this.make.graphics();
        g.fillStyle(0x223311); g.fillRect(0,0,64,64);
        g.fillStyle(0x2a4015); g.fillRect(0,0,64,2); g.fillRect(0,0,2,64);
        g.generateTexture('t_grass', 64, 64);
        
        g.clear(); g.fillStyle(0x555555); g.fillRect(0,0,64,64);
        g.lineStyle(2, 0x333333); g.strokeRect(0,0,64,64);
        g.generateTexture('t_stone', 64, 64);

        g.clear(); g.fillStyle(0xd4b568); g.fillCircle(8,8,6);
        g.generateTexture('fx_drop', 16, 16);

        this.createCharSprite('p_char', 0xcccccc, 0x2b8bc2);
        
        const k = this.make.graphics();
        k.fillStyle(0xa65e2e); k.fillRect(0,10,32,16); k.fillRect(0,6,12,12); k.fillStyle(0x000); k.fillRect(2,8,4,4);
        k.generateTexture('m_keltir', 32, 32);

        const w = this.make.graphics();
        w.fillStyle(0x666666); w.fillRect(0,8,32,20); w.fillRect(0,4,14,14); w.fillStyle(0xf00); w.fillRect(2,6,4,4);
        w.generateTexture('m_wolf', 32, 32);
    }

    createCharSprite(key, body, head) {
        const g = this.make.graphics();
        g.fillStyle(body); g.fillRect(8,8,16,24); g.fillStyle(head); g.fillRect(8,0,16,8);
        g.generateTexture(key, 32, 32);
    }

    create() {
        this.physics.world.setBounds(0,0,3000,3000);
        this.add.tileSprite(1500,1500,3000,3000,'t_grass').setDepth(-10);
        this.add.tileSprite(1500,1500,600,600,'t_stone').setDepth(-9);

        this.mobs = this.physics.add.group();
        this.allies = this.physics.add.group();
        this.drops = this.physics.add.group();

        this.player = new Unit(this, 1500, 1500, 'p_char', 'Hero');
        this.cameras.main.startFollow(this.player);
        this.cameras.main.setZoom(1.5);

        this.player.inventory = { 'weapon_d': 1, 'armor_d': 1, 'helm_d': 1, 'potion': 10, 'ssd': 500 };
        this.player.equipment = { weapon: null, armor: null, helm: null, gloves: null, boots: null };
        this.player.updateAppearance();
        this.player.adena = 0;

        this.spawnMobs();
        this.initShortcuts();

        this.input.on('pointerdown', p => {
            if(p.y > this.scale.height - 100) return;
            const wp = this.cameras.main.getWorldPoint(p.x, p.y);
            let t = null;
            this.mobs.getChildren().forEach(m => {
                if(m.active && Phaser.Geom.Rectangle.Contains(m.getBounds(), wp.x, wp.y)) t=m;
            });

            if(t) {
                if(this.player.target === t) {
                    this.player.attackTarget();
                } else {
                    this.player.setTarget(t);
                }
            } else {
                this.player.moveTo(wp.x, wp.y);
            }
        });

        this.makeDraggable('sys-menu', 'sys-drag');
        this.makeDraggable('inv-window', 'inv-drag');

        window.game = {
            scene: this,
            logic: { equip: k=>this.equipItem(k), unequip: s=>this.unequipItem(s) },
            ui: { toggleInv: ()=>this.toggleWindow('inv-window'), toggleSys: ()=>this.toggleWindow('sys-menu') },
            spawn: r=>this.spawnAlly(r),
            useSkill: id=>this.player.useSkill(id),
            useItem: id=>this.player.useItem(id),
            toggleAuto: ()=>this.player.toggleAuto(),
            toggleSS: ()=>this.player.toggleSS()
        };
        
        this.updateHUD();
        this.updateInvUI();
    }

    initShortcuts() {
        const bar = document.getElementById('shortcut-bar');
        bar.innerHTML = '';
        
        const slots = [
            { key: 'F1', type: 'skill', id: 'PowerStrike' },
            { key: 'F2', type: 'skill', id: 'Stun' },
            { key: 'F3', type: 'skill', id: 'HydroBlast' },
            { key: 'F4', type: 'skill', id: 'Heal' },
            { key: 'F5', type: 'item', id: 'potion' },
            { key: 'F6', type: 'action', icon: 'fa-bolt', color: '#00aaff', act: "game.toggleSS()", id: 'btn-ss' },
            { key: 'F7', type: 'action', icon: 'fa-sync', color: '#00ff00', act: "game.toggleAuto()", id: 'btn-auto' },
            { key: 'F8', type: 'action', icon: 'fa-user-plus', color: '#aaa', act: "game.spawn('PP')" },
            { key: 'F9', type: 'action', icon: 'fa-user-plus', color: '#aaa', act: "game.spawn('BD')" },
            { key: 'F10', type: 'action', icon: 'fa-user-plus', color: '#aaa', act: "game.spawn('SVS')" },
            { key: 'F11', type: 'action', icon: 'fa-cog', color: '#888', act: "game.ui.toggleSys()" },
            { key: 'F12', type: 'action', icon: 'fa-box-open', color: '#d4b568', act: "game.ui.toggleInv()" }
        ];

        slots.forEach(s => {
            const d = document.createElement('div');
            d.className = 'shot-slot';
            if(s.id) d.id = s.id;
            
            let content = '';
            let onClick = '';
            
            if (s.type === 'skill') {
                const sk = SKILLS[s.id];
                content = `<i class="fas ${sk.icon}" style="color:${sk.color}"></i>`;
                onClick = `game.useSkill('${s.id}')`;
                d.dataset.cooldownKey = s.id;
            } else if (s.type === 'item') {
                const it = ITEMS[s.id];
                content = `<div style="font-size:20px">${it.icon}</div>`;
                onClick = `game.useItem('${s.id}')`;
                d.dataset.cooldownKey = s.id;
            } else {
                content = `<i class="fas ${s.icon}" style="color:${s.color}"></i>`;
                onClick = s.act;
            }

            d.innerHTML = `${content}<span class="key">${s.key}</span><div class="cooldown"></div>`;
            d.onclick = () => eval(onClick);
            bar.appendChild(d);
        });
    }

    triggerCooldown(key, duration) {
        const el = document.querySelector(`[data-cooldown-key="${key}"] .cooldown`);
        if (!el) return;
        el.style.transition = 'none';
        el.style.height = '100%';
        el.offsetHeight; 
        el.style.transition = `height ${duration}ms linear`;
        el.style.height = '0%';
    }

    updateHUD() {
        const elName = document.getElementById('ui-name');
        if(elName) elName.innerText = this.player.nameText.text;
        const elHp = document.getElementById('hp-bar');
        if(elHp) elHp.style.width = (this.player.hp/this.player.maxHp*100)+'%';
        const elHpTxt = document.getElementById('hp-txt');
        if(elHpTxt) elHpTxt.innerText = Math.ceil(this.player.hp);
        const elMp = document.getElementById('mp-bar');
        if(elMp) elMp.style.width = (this.player.mp/this.player.maxMp*100)+'%';

        if(document.getElementById('ui-patk')) {
            const stats = this.player.getStats();
            document.getElementById('ui-patk').innerText = stats.pAtk;
            document.getElementById('ui-pdef').innerText = stats.pDef;
        }
        
        const tHud = document.getElementById('target-hud');
        if(tHud) {
            if(this.player.target && this.player.target.active) {
                tHud.style.display = 'block';
                document.getElementById('target-name').innerText = this.player.target.nameText.text;
                document.getElementById('target-hp-bar').style.width = (this.player.target.hp/this.player.target.maxHp*100)+'%';
            } else {
                tHud.style.display = 'none';
            }
        }
    }

    updateInvUI() {
        const grid = document.getElementById('inv-grid');
        if(!grid) return;
        grid.innerHTML = '';
        const elAdena = document.getElementById('ui-adena');
        if(elAdena) elAdena.innerText = this.player.adena;
        this.updateHUD();

        ['weapon','armor','helm','gloves','boots'].forEach(slot => {
            const el = document.getElementById(`slot-${slot}`);
            if(!el) return;
            const item = this.player.equipment[slot];
            if(item) {
                el.innerHTML = `<span style="font-size:20px">${ITEMS[item].icon}</span>`;
                el.classList.add('filled');
            } else {
                let icon = 'fa-question';
                if(slot==='weapon') icon = 'fa-khanda';
                if(slot==='armor') icon = 'fa-tshirt';
                if(slot==='helm') icon = 'fa-hard-hat';
                if(slot==='gloves') icon = 'fa-mitten';
                if(slot==='boots') icon = 'fa-boot';
                el.innerHTML = `<i class="fas ${icon} opacity-20"></i>`;
                el.classList.remove('filled');
            }
        });

        for(let key in this.player.inventory) {
            const qty = this.player.inventory[key];
            const item = ITEMS[key];
            if(!item) continue;
            const d = document.createElement('div');
            d.className = 'inv-slot';
            if(Object.values(this.player.equipment).includes(key)) d.classList.add('equipped');
            d.innerHTML = `<div style="font-size:20px">${item.icon}</div><span class="qty">${qty>1?qty:''}</span>`;
            d.onclick = () => { if(item.type==='gear') this.equipItem(key); else if(item.type==='use') this.player.useItem(key); };
            grid.appendChild(d);
        }
    }

    equipItem(key) {
        const item = ITEMS[key];
        if(this.player.equipment[item.slot] === key) this.unequipItem(item.slot);
        else { this.player.equipment[item.slot] = key; this.player.updateAppearance(); this.updateInvUI(); }
    }
    unequipItem(slot) { this.player.equipment[slot] = null; this.player.updateAppearance(); this.updateInvUI(); }
    toggleWindow(id) { const el=document.getElementById(id); if(el) { el.style.display=el.style.display==='flex'?'none':'flex'; if(id==='inv-window')this.updateInvUI(); } }
    makeDraggable(id, hId) {
        const el=document.getElementById(id), h=document.getElementById(hId);
        if(!el||!h)return;
        let isD=false, ox, oy;
        h.onmousedown=e=>{isD=true;ox=e.clientX-el.offsetLeft;oy=e.clientY-el.offsetTop;el.style.transform='none'};
        window.onmousemove=e=>{if(isD){el.style.left=(e.clientX-ox)+'px';el.style.top=(e.clientY-oy)+'px'}};
        window.onmouseup=()=>isD=false;
    }
    log(msg, type) {
        const b = document.getElementById('chat');
        if(!b) return;
        const d = document.createElement('div'); d.className = type; d.innerText = msg;
        b.appendChild(d); b.scrollTop = b.scrollHeight;
    }
    updateBuffUI(unit) {
        if (unit !== this.player) return;
        const c = document.getElementById('buff-container'); if(!c) return;
        c.innerHTML = ''; const now = this.time.now;
        for(let b in unit.activeBuffs) {
            if(unit.activeBuffs[b] > now) {
                const d = document.createElement('div'); d.className='buff-icon';
                d.style.borderColor = BUFFS[b].color;
                d.innerHTML=`<i class="fas ${BUFFS[b].icon}" style="color:${BUFFS[b].color}"></i>`;
                c.appendChild(d);
            }
        }
    }
    spawnMobs() {
        for(let i=0; i<25; i++) {
            const x=Phaser.Math.Between(800,2200), y=Phaser.Math.Between(800,2200);
            if(Math.abs(x-1500)<350 && Math.abs(y-1500)<350) continue;
            const type = Math.random()>0.5 ? 'm_keltir':'m_wolf';
            const m = new Unit(this, x, y, type, type==='m_keltir'?'Keltir':'Wolf', true);
            this.mobs.add(m);
        }
    }
    spawnAlly(role) {
        if(this.allies.getLength() >= 3) return;
        const all = [this.player, ...this.allies.getChildren()];
        const prev = all[all.length-1];
        const ally = new SupportUnit(this, prev.x, prev.y, 'p_char', role);
        ally.setTint(0xaaaaff); ally.followTarget = prev; 
        this.allies.add(ally);
        const pl = document.getElementById('party-list');
        if(pl) {
            const d=document.createElement('div');d.className='party-member';
            d.innerHTML=`<div>${role}</div><div class="pm-bar"><div class="pm-hp"></div></div>`;
            pl.appendChild(d);
        }
    }
    spawnDrop(x, y) {
        const d = this.physics.add.sprite(x, y, 'fx_drop');
        this.tweens.add({ targets:d, y: y+20, duration: 500, ease:'Bounce', onComplete:()=>{
            this.time.delayedCall(500, ()=>{
                this.tweens.add({ targets:d, x:this.player.x, y:this.player.y, duration:300, onComplete:()=>{
                    d.destroy();
                    this.player.adena += Phaser.Math.Between(50,150);
                    const invWin = document.getElementById('inv-window');
                    if(invWin && invWin.style.display === 'flex') this.updateInvUI();
                    this.log('Picked up Adena.', 'gain');
                }});
            });
        }});
    }
    update(time) {
        this.player.update(time);
        this.mobs.getChildren().forEach(m => m.update(time));
        this.allies.getChildren().forEach(a => a.update(time));
    }
}

class Unit extends Phaser.GameObjects.Container {
    constructor(scene, x, y, key, name, isMob=false) {
        super(scene, x, y);
        this.scene = scene; this.isMob = isMob;
        this.hp = 100; this.maxHp = 100; this.mp = 50; this.maxMp = 50;
        this.activeBuffs = {};
        this.baseStats = { pAtk:15, pDef:10, atkSpd:600, critRate:0.1, critDmg:2.0 };
        this.cooldowns = {};
        this.isAttacking = false; // Initialized

        this.visualContainer = scene.add.container(0,0);
        this.add(this.visualContainer);

        if(isMob) {
            this.visual = scene.add.sprite(0,0,key);
            this.visualContainer.add(this.visual);
        } else {
            this.updateAppearance();
        }

        const col = isMob ? '#ff5555' : '#fff';
        this.nameText = scene.add.text(0,-25,name,{fontSize:'10px',color:col, stroke:'#000', strokeThickness:2}).setOrigin(0.5);
        this.add(this.nameText);

        scene.physics.add.existing(this);
        this.body.setCircle(12,-12,-12);
        this.body.setCollideWorldBounds(true);
        scene.add.existing(this);
        this.atkTimer=0;
    }
    
    setTarget(t) { this.target = t; this.scene.updateHUD(); }
    setTint(color) { if(this.visual) this.visual.setTint(color); }
    
    updateAppearance() {
        if(this.isMob) return;
        this.visualContainer.removeAll(true);
        const g = this.scene.make.graphics();
        g.fillStyle(0xffccaa); g.fillRect(10, 2, 12, 6); 
        g.fillRect(10, 8, 12, 18); 
        const eq = this.equipment || {};
        if(eq.boots) g.fillStyle(ITEMS[eq.boots].color); else g.fillStyle(0x555555);
        g.fillRect(10, 20, 12, 6);
        if(eq.armor) g.fillStyle(ITEMS[eq.armor].color); else g.fillStyle(0xeeeeee);
        g.fillRect(10, 8, 12, 12);
        if(eq.gloves) { g.fillStyle(ITEMS[eq.gloves].color); g.fillRect(8, 12, 2, 4); g.fillRect(22, 12, 2, 4); }
        if(eq.helm) { g.fillStyle(ITEMS[eq.helm].color); g.fillRect(10, 0, 12, 4); }
        if(eq.weapon) { 
            g.fillStyle(0x888888); g.fillRect(22, 6, 4, 16); 
            g.fillStyle(0x553311); g.fillRect(23, 22, 2, 4); 
        }
        const textureKey = 'char_' + Date.now() + Math.random();
        g.generateTexture(textureKey, 32, 32);
        this.visual = this.scene.add.sprite(0,0,textureKey);
        this.visualContainer.add(this.visual);
        g.destroy();
    }

    getStats() {
        let s = {...this.baseStats};
        const now = this.scene.time.now;
        for(let b in this.activeBuffs) {
            if(this.activeBuffs[b] > now) {
                const buff = BUFFS[b];
                if(buff.stat==='atkSpd') s.atkSpd *= buff.val; else s[buff.stat] = Math.floor(s[buff.stat]*buff.val);
            }
        }
        if(!this.isMob && this.equipment) {
            if(this.equipment.weapon) s.pAtk += ITEMS[this.equipment.weapon].pAtk;
            if(this.equipment.armor) s.pDef += ITEMS[this.equipment.armor].pDef;
        }
        return s;
    }

    useSkill(skillId) {
        const skill = SKILLS[skillId];
        const now = this.scene.time.now;
        if (this.cooldowns[skillId] && this.cooldowns[skillId] > now) { this.scene.log("Skill is not ready.", 'sys'); return; }
        if (this.mp < (skill.cost || 0)) { this.scene.log("Not enough MP.", 'sys'); return; }
        if (skill.type === 'buff' || skill.type === 'heal') {
            this.performSkill(skill);
        } else {
            if (!this.target || !this.target.active) { this.scene.log("Invalid target.", 'sys'); return; }
            const dist = Phaser.Math.Distance.Between(this.x, this.y, this.target.x, this.target.y);
            if (dist > (skill.range || 150)) { this.scene.log("Target too far.", 'sys'); return; }
            this.performSkill(skill);
        }
        this.cooldowns[skillId] = now + skill.cd;
        this.scene.triggerCooldown(skillId, skill.cd);
        this.mp -= (skill.cost || 0);
        this.scene.updateHUD();
    }

    performSkill(skill) {
        const txt = this.scene.add.text(this.x, this.y - 60, skill.name, { fontSize: '12px', color: skill.color, stroke: '#000', strokeThickness: 3 }).setOrigin(0.5);
        this.scene.tweens.add({ targets: txt, y: this.y - 100, alpha: 0, duration: 1000, onComplete: () => txt.destroy() });
        if (skill.type === 'heal') {
            this.hp = Math.min(this.hp + skill.val, this.maxHp);
            this.scene.log(`Healed for ${skill.val}.`, 'gain');
            this.scene.updateHUD();
        } else if (skill.type === 'buff') {
            this.applyBuff(skill.name); 
        } else {
            let dmg = this.getStats().pAtk * skill.dmgMod;
            this.target.takeDamage(Math.floor(dmg));
        }
    }

    useItem(itemId) {
        const item = ITEMS[itemId];
        if (this.inventory[itemId] > 0) {
            if (item.type === 'use') {
                if (item.heal) {
                    this.hp = Math.min(this.hp + item.heal, this.maxHp);
                    this.inventory[itemId]--;
                    this.scene.updateInvUI();
                    this.scene.triggerCooldown(itemId, item.cd || 1000);
                    this.scene.log(`Used ${item.name}.`, 'gain');
                }
            }
        }
    }

    applyBuff(buffName) {
        const buff = BUFFS[buffName];
        if(!buff) return;
        this.activeBuffs[buffName] = this.scene.time.now + buff.dur;
        if(!this.isMob && this === this.scene.player) this.scene.updateBuffUI(this);
        const fx = this.scene.add.text(this.x, this.y-40, buffName, {fontSize:'10px', color:buff.color, stroke:'#000', strokeThickness:2}).setOrigin(0.5);
        this.scene.tweens.add({targets:fx, y:this.y-60, alpha:0, duration:1000, onComplete:()=>fx.destroy()});
    }

    update(time) {
        this.setDepth(this.y);
        if(this.isMob) {
            if(Math.random()<0.01) this.body.setVelocity(Phaser.Math.Between(-20,20), Phaser.Math.Between(-20,20));
            return;
        }
        if(this.followTarget) {
            if(Phaser.Math.Distance.Between(this.x,this.y,this.followTarget.x,this.followTarget.y)>45)
                this.scene.physics.moveToObject(this, this.followTarget, 160);
            else this.body.reset(this.x,this.y);
            return;
        }
        
        if(this === this.scene.player && time%1000 < 20) {
            this.scene.updateBuffUI(this);
            this.scene.updateHUD();
        }
        if(this.auto) {
            if(!this.target || !this.target.active) {
                let min=800, c=null;
                this.scene.mobs.getChildren().forEach(m=>{
                    const d=Phaser.Math.Distance.Between(this.x,this.y,m.x,m.y);
                    if(d<min){min=d;c=m;}
                });
                this.target=c;
            }
            if(this.target) {
                const d=Phaser.Math.Distance.Between(this.x,this.y,this.target.x,this.target.y);
                if(d>40) this.scene.physics.moveToObject(this,this.target,160);
                else { this.body.reset(this.x,this.y); this.attack(time); }
            }
        } else if(this.moveDest) {
            if(Phaser.Math.Distance.Between(this.x,this.y,this.moveDest.x,this.moveDest.y)<10) { // Increased distance
                this.body.reset(this.x,this.y); this.moveDest=null;
            }
        } else if (this.isAttacking && this.target && this.target.active) {
            const d=Phaser.Math.Distance.Between(this.x,this.y,this.target.x,this.target.y);
            if(d>40) this.scene.physics.moveToObject(this,this.target,160);
            else { this.body.reset(this.x,this.y); this.attack(time); }
        }
    }

    moveTo(x,y) {
        this.auto=false; this.isAttacking=false; this.target=null;
        const btn = document.getElementById('btn-auto'); if(btn) btn.classList.remove('active');
        this.moveDest={x,y}; this.scene.physics.moveTo(this,x,y,180);
    }
    toggleAuto() {
        this.auto=!this.auto; 
        const btn = document.getElementById('btn-auto');
        if(btn) this.auto ? btn.classList.add('active') : btn.classList.remove('active');
        if(!this.auto) { this.target=null; this.body.reset(this.x,this.y); }
    }
    toggleSS() {
        this.ss=!this.ss; document.getElementById('btn-ss').classList.toggle('active');
    }
    attackTarget() { this.isAttacking = true; this.moveDest = null; }

    tryAttack() {
        if(this.target && this.target.active) {
            if(Phaser.Math.Distance.Between(this.x,this.y,this.target.x,this.target.y)<=50) this.attack(this.scene.time.now);
        }
    }
    attack(time) {
        const stats = this.getStats();
        if(time-this.atkTimer > stats.atkSpd) {
            this.scene.tweens.add({targets:this.visual, x:(this.target.x-this.x)*0.3, y:(this.target.y-this.y)*0.3, yoyo:true, duration:50});
            let dmg=stats.pAtk;
            if(Math.random()<0.2) dmg*=2;
            if(this.ss) { 
                dmg*=2; 
                const fx=this.scene.add.circle(this.target.x,this.target.y,20,0x00aaff,0.6);
                this.scene.tweens.add({targets:fx, scale:0, duration:200, onComplete:()=>fx.destroy()});
            }
            this.target.takeDamage(Math.floor(dmg));
            this.atkTimer=time;
        }
    }
    takeDamage(val) {
        this.hp-=val;
        const t=this.scene.add.text(this.x,this.y-30,val,{fontFamily:'Tahoma',fontSize:'14px',color:'#fff',stroke:'#000',strokeThickness:3}).setOrigin(0.5).setDepth(1000);
        this.scene.tweens.add({targets:t, y:this.y-60, alpha:0, duration:800, onComplete:()=>t.destroy()});
        if(this.hp<=0) {
            const scene=this.scene, isMob=this.isMob, name=this.nameText.text, x=this.x, y=this.y;
            this.destroy();
            if(isMob && scene) {
                if(scene.player.active) {
                    scene.log(`Kill: ${name}`, 'drop');
                    if(Math.random()>0.3) scene.spawnDrop(x,y);
                }
                scene.time.delayedCall(2000, ()=>{
                    if(!scene.mobs.scene) return;
                    const type=Math.random()>0.5?'m_keltir':'m_wolf';
                    const m=new Unit(scene, Math.random()*2000+500, Math.random()*2000+500, type, type==='m_keltir'?'Keltir':'Wolf', true);
                    scene.mobs.add(m);
                });
            }
        }
    }
}

class SupportUnit extends Unit {
    constructor(scene, x, y, key, role) {
        super(scene, x, y, key, role, false);
        // CRITICAL FIX: Initialize equipment for appearance update
        this.equipment = { weapon: null, armor: null, helm: null, gloves: null, boots: null };
        this.updateAppearance();
        
        this.role = role;
        this.leader = scene.player;
        this.buffTimer = 0;
        this.buffsToCast = [];
        if(role==='PP') this.buffsToCast=['Might','Shield','Haste'];
        if(role==='BD') this.buffsToCast=['Dance of Fire'];
        if(role==='SVS') this.buffsToCast=['Song of Hunter'];
    }
    update(time) {
        super.update(time);
        if(time - this.buffTimer > 5000) {
            this.buffsToCast.forEach(b => {
                if(this.leader.activeBuffs[b] === undefined || this.leader.activeBuffs[b] < time+60000) {
                    this.leader.applyBuff(b);
                    const cast = this.scene.add.circle(this.x,this.y,30,0x00ff00,0.3);
                    this.scene.tweens.add({targets:cast, scale:0, duration:500, onComplete:()=>cast.destroy()});
                }
            });
            this.buffTimer = time;
        }
    }
}

const config = {
    type: Phaser.AUTO, parent: 'game-container', scale: { mode: Phaser.Scale.RESIZE },
    pixelArt: true, backgroundColor: '#000',
    physics: { default: 'arcade', arcade: { debug: false } },
    scene: [GameScene]
};
new Phaser.Game(config);
</script>
</body>
</html>
